# Admin Package Management API

API d√†nh cho Admin ƒë·ªÉ qu·∫£n l√Ω Subscription Packages v√† API Extension Packages.

---

## üîê Authentication

T·∫•t c·∫£ endpoints y√™u c·∫ßu:
1. **JWT Token** trong header `Authorization: Bearer <token>`
2. **Admin Role**: User ph·∫£i c√≥ `role = 'admin'`

---

## üìã M·ª•c l·ª•c

1. [Subscription Packages Management](#subscription-packages-management)
2. [API Extension Packages Management](#api-extension-packages-management)
3. [Overview & Statistics](#overview--statistics)
4. [Examples](#examples)

---

## üì¶ Subscription Packages Management

### 1. Get All Subscription Packages

**GET** `/api/admin/packages/subscriptions`

L·∫•y t·∫•t c·∫£ g√≥i subscription (bao g·ªìm inactive n·∫øu mu·ªën).

**Query Parameters:**
- `includeInactive` (optional): `true` ƒë·ªÉ bao g·ªìm g√≥i inactive

**Response (200):**
```json
[
  {
    "id": "uuid",
    "name": "G√≥i C∆° B·∫£n",
    "description": "G√≥i c∆° b·∫£n cho ng∆∞·ªùi d√πng m·ªõi",
    "price": "99000.00",
    "currency": "VND",
    "durationDays": 30,
    "maxVirtualPortfolios": 3,
    "apiLimit": 1000,
    "features": {
      "realTimeData": false,
      "advancedCharts": false
    },
    "isActive": true,
    "createdAt": "2025-10-01T00:00:00.000Z",
    "updatedAt": "2025-10-01T00:00:00.000Z"
  }
]
```

**cURL:**
```bash
curl -X GET "http://localhost:3000/api/admin/packages/subscriptions?includeInactive=true" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 2. Get Subscription Package by ID

**GET** `/api/admin/packages/subscriptions/:id`

L·∫•y th√¥ng tin chi ti·∫øt c·ªßa m·ªôt g√≥i subscription.

**Response (200):**
```json
{
  "id": "uuid",
  "name": "G√≥i C∆° B·∫£n",
  "description": "G√≥i c∆° b·∫£n cho ng∆∞·ªùi d√πng m·ªõi",
  "price": "99000.00",
  "currency": "VND",
  "durationDays": 30,
  "maxVirtualPortfolios": 3,
  "apiLimit": 1000,
  "features": {},
  "isActive": true,
  "createdAt": "2025-10-01T00:00:00.000Z",
  "updatedAt": "2025-10-01T00:00:00.000Z"
}
```

**Response (404):**
```json
{
  "statusCode": 404,
  "message": "G√≥i subscription kh√¥ng t·ªìn t·∫°i"
}
```

**cURL:**
```bash
curl -X GET http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 3. Create Subscription Package

**POST** `/api/admin/packages/subscriptions`

T·∫°o g√≥i subscription m·ªõi.

**Request Body:**
```json
{
  "name": "G√≥i Pro Max",
  "description": "G√≥i cao c·∫•p nh·∫•t",
  "price": 499000,
  "currency": "VND",
  "durationDays": 30,
  "maxVirtualPortfolios": 20,
  "apiLimit": 10000,
  "features": {
    "realTimeData": true,
    "advancedCharts": true,
    "customAlerts": true
  },
  "isActive": true
}
```

**Validation Rules:**
- `name` (string, required): T√™n g√≥i (unique)
- `description` (string, optional): M√¥ t·∫£
- `price` (number, required, >= 0): Gi√°
- `currency` (string, required): M√£ ti·ªÅn t·ªá
- `durationDays` (number, required, >= 1): Th·ªùi h·∫°n (ng√†y)
- `maxVirtualPortfolios` (number, optional, >= 1): S·ªë portfolio t·ªëi ƒëa
- `apiLimit` (number, optional, >= 1): Gi·ªõi h·∫°n API calls
- `features` (object, optional): C√°c t√≠nh nƒÉng
- `isActive` (boolean, optional, default: true): Tr·∫°ng th√°i

**Response (201):**
```json
{
  "id": "new-uuid",
  "name": "G√≥i Pro Max",
  "description": "G√≥i cao c·∫•p nh·∫•t",
  "price": "499000.00",
  "currency": "VND",
  "durationDays": 30,
  "maxVirtualPortfolios": 20,
  "apiLimit": 10000,
  "features": {
    "realTimeData": true,
    "advancedCharts": true,
    "customAlerts": true
  },
  "isActive": true,
  "createdAt": "2025-10-05T10:00:00.000Z",
  "updatedAt": "2025-10-05T10:00:00.000Z"
}
```

**Response (400):**
```json
{
  "statusCode": 400,
  "message": "T√™n g√≥i ƒë√£ t·ªìn t·∫°i"
}
```

**cURL:**
```bash
curl -X POST http://localhost:3000/api/admin/packages/subscriptions \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "G√≥i Pro Max",
    "price": 499000,
    "currency": "VND",
    "durationDays": 30,
    "apiLimit": 10000
  }'
```

---

### 4. Update Subscription Package

**PUT** `/api/admin/packages/subscriptions/:id`

C·∫≠p nh·∫≠t th√¥ng tin g√≥i subscription.

**Request Body:**
```json
{
  "price": 399000,
  "apiLimit": 15000,
  "features": {
    "realTimeData": true,
    "advancedCharts": true,
    "prioritySupport": true
  }
}
```

**Note:** T·∫•t c·∫£ fields ƒë·ªÅu optional, ch·ªâ c·∫ßn g·ª≠i nh·ªØng field mu·ªën update.

**Response (200):**
```json
{
  "id": "uuid",
  "name": "G√≥i Pro Max",
  "price": "399000.00",
  "apiLimit": 15000,
  "features": {
    "realTimeData": true,
    "advancedCharts": true,
    "prioritySupport": true
  },
  "updatedAt": "2025-10-05T11:00:00.000Z"
}
```

**cURL:**
```bash
curl -X PUT http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "price": 399000,
    "apiLimit": 15000
  }'
```

---

### 5. Delete Subscription Package

**DELETE** `/api/admin/packages/subscriptions/:id`

X√≥a g√≥i subscription (soft delete - set `isActive = false`).

**Response (204):** No Content

**Response (400):**
```json
{
  "statusCode": 400,
  "message": "Kh√¥ng th·ªÉ x√≥a g√≥i v√¨ c√≥ 15 subscription ƒëang active"
}
```

**cURL:**
```bash
curl -X DELETE http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 6. Get Subscription Package Statistics

**GET** `/api/admin/packages/subscriptions/:id/stats`

Xem th·ªëng k√™ usage c·ªßa m·ªôt g√≥i subscription.

**Response (200):**
```json
{
  "package": {
    "id": "uuid",
    "name": "G√≥i C∆° B·∫£n",
    "price": "99000.00",
    "apiLimit": 1000
  },
  "stats": {
    "totalSubscriptions": 150,
    "activeSubscriptions": 85,
    "totalRevenue": 14850000
  }
}
```

**cURL:**
```bash
curl -X GET http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID/stats \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## üîÑ API Extension Packages Management

### 1. Get All API Extension Packages

**GET** `/api/admin/packages/extensions`

L·∫•y t·∫•t c·∫£ g√≥i m·ªü r·ªông API.

**Query Parameters:**
- `includeInactive` (optional): `true` ƒë·ªÉ bao g·ªìm g√≥i inactive

**Response (200):**
```json
[
  {
    "id": "uuid",
    "name": "G√≥i M·ªü R·ªông 1K",
    "description": "Th√™m 1,000 API calls",
    "additionalCalls": 1000,
    "price": "49000.00",
    "currency": "VND",
    "isActive": true,
    "createdAt": "2025-10-01T00:00:00.000Z",
    "updatedAt": "2025-10-01T00:00:00.000Z"
  }
]
```

**cURL:**
```bash
curl -X GET "http://localhost:3000/api/admin/packages/extensions?includeInactive=true" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 2. Get API Extension Package by ID

**GET** `/api/admin/packages/extensions/:id`

L·∫•y th√¥ng tin chi ti·∫øt c·ªßa m·ªôt g√≥i m·ªü r·ªông.

**Response (200):**
```json
{
  "id": "uuid",
  "name": "G√≥i M·ªü R·ªông 5K",
  "description": "Th√™m 5,000 API calls - Ti·∫øt ki·ªám 20%",
  "additionalCalls": 5000,
  "price": "199000.00",
  "currency": "VND",
  "isActive": true,
  "createdAt": "2025-10-01T00:00:00.000Z",
  "updatedAt": "2025-10-01T00:00:00.000Z"
}
```

**cURL:**
```bash
curl -X GET http://localhost:3000/api/admin/packages/extensions/$EXTENSION_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 3. Create API Extension Package

**POST** `/api/admin/packages/extensions`

T·∫°o g√≥i m·ªü r·ªông m·ªõi.

**Request Body:**
```json
{
  "name": "G√≥i M·ªü R·ªông 20K",
  "description": "Th√™m 20,000 API calls - Ti·∫øt ki·ªám 40%",
  "additionalCalls": 20000,
  "price": 599000,
  "currency": "VND",
  "isActive": true
}
```

**Validation Rules:**
- `name` (string, required): T√™n g√≥i (unique)
- `description` (string, optional): M√¥ t·∫£
- `additionalCalls` (number, required, >= 1): S·ªë calls th√™m
- `price` (number, required, >= 0): Gi√°
- `currency` (string, required): M√£ ti·ªÅn t·ªá
- `isActive` (boolean, optional, default: true): Tr·∫°ng th√°i

**Response (201):**
```json
{
  "id": "new-uuid",
  "name": "G√≥i M·ªü R·ªông 20K",
  "description": "Th√™m 20,000 API calls - Ti·∫øt ki·ªám 40%",
  "additionalCalls": 20000,
  "price": "599000.00",
  "currency": "VND",
  "isActive": true,
  "createdAt": "2025-10-05T10:00:00.000Z",
  "updatedAt": "2025-10-05T10:00:00.000Z"
}
```

**cURL:**
```bash
curl -X POST http://localhost:3000/api/admin/packages/extensions \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "G√≥i M·ªü R·ªông 20K",
    "additionalCalls": 20000,
    "price": 599000,
    "currency": "VND"
  }'
```

---

### 4. Update API Extension Package

**PUT** `/api/admin/packages/extensions/:id`

C·∫≠p nh·∫≠t g√≥i m·ªü r·ªông.

**Request Body:**
```json
{
  "price": 549000,
  "description": "Th√™m 20,000 API calls - Khuy·∫øn m√£i 45%"
}
```

**Response (200):**
```json
{
  "id": "uuid",
  "name": "G√≥i M·ªü R·ªông 20K",
  "description": "Th√™m 20,000 API calls - Khuy·∫øn m√£i 45%",
  "additionalCalls": 20000,
  "price": "549000.00",
  "currency": "VND",
  "isActive": true,
  "updatedAt": "2025-10-05T11:00:00.000Z"
}
```

**cURL:**
```bash
curl -X PUT http://localhost:3000/api/admin/packages/extensions/$EXTENSION_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "price": 549000
  }'
```

---

### 5. Delete API Extension Package

**DELETE** `/api/admin/packages/extensions/:id`

X√≥a g√≥i m·ªü r·ªông (soft delete).

**Response (204):** No Content

**cURL:**
```bash
curl -X DELETE http://localhost:3000/api/admin/packages/extensions/$EXTENSION_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 6. Get API Extension Package Statistics

**GET** `/api/admin/packages/extensions/:id/stats`

Xem th·ªëng k√™ usage c·ªßa g√≥i m·ªü r·ªông.

**Response (200):**
```json
{
  "package": {
    "id": "uuid",
    "name": "G√≥i M·ªü R·ªông 5K",
    "additionalCalls": 5000,
    "price": "199000.00"
  },
  "stats": {
    "totalPurchases": 45,
    "totalRevenue": 8955000,
    "totalCallsSold": 225000
  }
}
```

**cURL:**
```bash
curl -X GET http://localhost:3000/api/admin/packages/extensions/$EXTENSION_ID/stats \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## üìä Overview & Statistics

### Get Packages Overview

**GET** `/api/admin/packages/overview`

Xem t·ªïng quan v·ªÅ t·∫•t c·∫£ c√°c g√≥i v√† revenue.

**Response (200):**
```json
{
  "subscriptionPackages": {
    "total": 4,
    "active": 3,
    "packages": [
      {
        "id": "uuid",
        "name": "G√≥i C∆° B·∫£n",
        "price": "99000.00",
        "apiLimit": 1000,
        "isActive": true
      }
    ]
  },
  "extensionPackages": {
    "total": 3,
    "active": 3,
    "packages": [
      {
        "id": "uuid",
        "name": "G√≥i M·ªü R·ªông 1K",
        "additionalCalls": 1000,
        "price": "49000.00",
        "isActive": true
      }
    ]
  },
  "usage": {
    "totalSubscriptions": 250,
    "activeSubscriptions": 180,
    "totalExtensionPurchases": 85
  },
  "revenue": {
    "subscriptions": 34500000,
    "extensions": 12450000,
    "total": 46950000
  }
}
```

**cURL:**
```bash
curl -X GET http://localhost:3000/api/admin/packages/overview \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## üí° Examples

### Complete Admin Workflow

#### 1. Login as Admin
```bash
ADMIN_TOKEN=$(curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "admin-password"
  }' | jq -r '.accessToken')
```

#### 2. View Overview
```bash
curl -X GET http://localhost:3000/api/admin/packages/overview \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

#### 3. Create New Subscription Package
```bash
curl -X POST http://localhost:3000/api/admin/packages/subscriptions \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "G√≥i VIP",
    "description": "G√≥i VIP cao c·∫•p",
    "price": 1999000,
    "currency": "VND",
    "durationDays": 365,
    "maxVirtualPortfolios": 50,
    "apiLimit": 999999,
    "features": {
      "everything": true
    }
  }'
```

#### 4. Create New Extension Package
```bash
curl -X POST http://localhost:3000/api/admin/packages/extensions \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "G√≥i M·ªü R·ªông 50K",
    "description": "Th√™m 50,000 API calls - Best value!",
    "additionalCalls": 50000,
    "price": 1299000,
    "currency": "VND"
  }'
```

#### 5. View Package Statistics
```bash
# Subscription package stats
curl -X GET http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID/stats \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# Extension package stats
curl -X GET http://localhost:3000/api/admin/packages/extensions/$EXTENSION_ID/stats \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

#### 6. Update Package
```bash
# Update price
curl -X PUT http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "price": 1799000,
    "description": "G√≥i VIP cao c·∫•p - Khuy·∫øn m√£i 10%"
  }'
```

#### 7. Deactivate Package
```bash
curl -X PUT http://localhost:3000/api/admin/packages/subscriptions/$PACKAGE_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "isActive": false
  }'
```

---

## üìã Summary

### Subscription Packages Endpoints (6)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/admin/packages/subscriptions` | List all |
| GET | `/admin/packages/subscriptions/:id` | Get details |
| POST | `/admin/packages/subscriptions` | Create |
| PUT | `/admin/packages/subscriptions/:id` | Update |
| DELETE | `/admin/packages/subscriptions/:id` | Delete |
| GET | `/admin/packages/subscriptions/:id/stats` | Statistics |

### API Extension Packages Endpoints (6)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/admin/packages/extensions` | List all |
| GET | `/admin/packages/extensions/:id` | Get details |
| POST | `/admin/packages/extensions` | Create |
| PUT | `/admin/packages/extensions/:id` | Update |
| DELETE | `/admin/packages/extensions/:id` | Delete |
| GET | `/admin/packages/extensions/:id/stats` | Statistics |

### Overview Endpoint (1)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/admin/packages/overview` | Full overview |

**Total: 13 new admin endpoints**

---

## üîí Security Notes

1. **Admin Only**: T·∫•t c·∫£ endpoints y√™u c·∫ßu admin role
2. **Soft Delete**: Delete operations set `isActive = false`
3. **Validation**: NgƒÉn x√≥a packages ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng
4. **Audit**: N√™n log t·∫•t c·∫£ admin actions

---

## ‚ö†Ô∏è Important Notes

### Khi x√≥a Subscription Package:
- ‚úÖ ƒê∆∞·ª£c ph√©p n·∫øu kh√¥ng c√≥ active subscriptions
- ‚ùå B·ªã ch·∫∑n n·∫øu c√≥ users ƒëang s·ª≠ d·ª•ng
- üí° Soft delete (set `isActive = false`)

### Khi t·∫°o Package:
- Name ph·∫£i unique
- Price >= 0
- DurationDays >= 1 (cho subscription)
- AdditionalCalls >= 1 (cho extension)

### Statistics:
- Real-time data
- T√≠nh c·∫£ expired/cancelled subscriptions
- Revenue = t·ªïng gi√° tr·ªã ƒë√£ thu

---

**Last Updated:** 2025-10-05  
**Version:** 2.0.0  
**Total Endpoints:** 13 admin endpoints

